var potterQuest = (function() {
  var backgrounds = {
    initBackground: "<%= asset_path('game_title.png')%>",
    fullBackground: "<%= asset_path('background-sprite.png')%>"
  }

  var avatars = {
    harry: "<%= asset_path('harry_potter_sprite.png')%>"
  }

  /* Game Constructor and Methods */
  function Game() {
    this.elem = $('.game-container')[0];
    this.bounds = null;
    this.scenePos = {
      x: -70,
      y: -830
    }
    this.sceneShift = {
      x: 770,
      y: 590
    }
    this.gameSpeed = 75;
    this.state = 'init';
    this.score = 0;
    this.time = 0;
    this.characters = [];
    this.obstacles = [];
    this.typing = {
      show: false,
      phrase: ''
    };
    this.responding = {
      show: false,
      phrase: ''
    }
  }

  Game.prototype.init = function() {
    $(this.elem).css({
      'background-image': 'url(' + backgrounds.initBackground + ')',
      'background-size': '100% 100%'
    });
    this.initEventHandlers(this);
    this.loopHandle = setInterval(function() {
      game.run();
    }, this.gameSpeed);
  }

  Game.prototype.initEventHandlers = function(self) {
    // Start/Play Game button
    $('.game-container').on('click', '.startBtn', function() {
      if (self.state === 'init') {
        $('.game-container').find('.startBtn').hide();
        self.state = 'welcome';
        self.addCharacter('Harry Potter', avatars.harry);
      }
    });
    // Handle key presses
    $('body').keyup(function(event) {
      self.handleKeyUp(event.which);
    });
    $('body').keypress(function(event) {
      self.handleKeyPress(event.which);
    });
  }

  Game.prototype.run = function() {
    this.time++;
    this.checkState();
    this.updateGame();
  }

  Game.prototype.checkState = function() {
    switch (this.state) {
      case 'init':
        // Do nothing.
        break;
      case 'welcome':
        this.runCastle();
        break;
    }
  }

  Game.prototype.runCastle = function() {
    $(this.elem).css({
      'background-image': 'url(' + backgrounds.fullBackground + ')',
      'background-size': '890% 872%', //890%, 865%
      'background-position': this.scenePos.x + 'px ' + this.scenePos.y + 'px'
    });
  }

  Game.prototype.checkTyping = function(phrase) {
    phrase = phrase.toLowerCase();
    if (phrase.includes('look at tree')) {
      this.responding.phrase = 'The tree is a normal tree.';
    } else {
      this.responding.phrase = "I don't understand that.";
    }
    $('.dialog').text(this.responding.phrase).show();
    this.responding.show = true;
  }

  Game.prototype.handleKeyPress = function(key) {
    switch (this.state) {
      case 'init':
        // Do nothing.
        break;
      case 'welcome':
        if (key >= 48 && key <= 220) {
          this.typing.show = true;
          var char = String.fromCharCode(key);
          this.typing.phrase += char;
          $('.typing').text(this.typing.phrase).show();
        } else if (key === 13) {
          // Enter
          if (this.typing.show) {
            this.typing.show = false;
            $('.typing').hide();
            var userPhrase = this.typing.phrase;
            this.typing.phrase = '';
            this.checkTyping(userPhrase);
          } else if (this.responding.show) {
            this.responding.show = false;
            $('.dialog').text("Testing").hide();
          }
        } else if (key === 32) {
          // Space
          if (this.typing.phrase.length > 1) {
            this.typing.phrase += ' ';
            $('.typing').text(this.typing.phrase).show();
          }
        }
        break;
    }
  }

  Game.prototype.handleKeyUp = function(key) {
    switch (this.state) {
      case 'init':
        // Do nothing.
        break;
      case 'welcome':
        var action = this.characters[0].action;
        switch (key) {
          case 8:
            // Backspace
            if (this.typing.phrase.length > 1) {
              this.typing.phrase = this.typing.phrase.substring(0, this.typing.phrase.length - 1);
              $('.typing').text(this.typing.phrase).show();
            } else {
              this.typing.phrase = '';
              $('.typing').hide();
            }
            break;
          case 37:
            action = (action === 'walk-left') ? 'stop' : 'walk-left';
            break;
          case 38:
            action = (action === 'walk-up') ? 'stop' : 'walk-up';
            break;
          case 39:
            action = (action === 'walk-right') ? 'stop' : 'walk-right';
            break;
          case 40:
            action = (action === 'walk-down') ? 'stop' : 'walk-down';
            break;
        }
        this.characters[0].action = action;
        break;
    }
  }

  Game.prototype.updateGame = function() {
    if (this.state !== 'init') {
      this.bounds = this.elem.getBoundingClientRect();
    }
    var allCharacters = this.characters;
    for (var index = 0; index < allCharacters.length; index++) {
      var character = allCharacters[index];
      character.updateCharacter();
      this.checkCollisions();
    }
  }

  Game.prototype.checkCollisions = function() {
    this.checkBorders();
    this.checkObstacles();
  }

  Game.prototype.checkBorders = function() {
    var character = this.characters[0];
    var gameBounds = this.bounds;
    var charBounds = character.bounds;
    var action = character.action;

    if (action === 'walk-left' && charBounds.left < gameBounds.left) {
      character.x = 700;
      this.scenePos.x = this.scenePos.x + this.sceneShift.x;
    }
    if (action === 'walk-right' && charBounds.right > gameBounds.right) {
      character.x = 0;
      this.scenePos.x = this.scenePos.x - this.sceneShift.x;
    }
    if (action === 'walk-up' && charBounds.top < gameBounds.top) {
      character.y = 500;
      this.scenePos.y = this.scenePos.y + this.sceneShift.y;
    }
    if (action === 'walk-down' && charBounds.bottom > gameBounds.bottom) {
      character.y = 0;
      this.scenePos.y = this.scenePos.y - this.sceneShift.y;
    }
    if (this.scenePos.x > -70) {
      this.scenePos.x = -5460;
    }
    if (this.scenePos.x < -5460) {
      this.scenePos.x = -70;
    }
    $(this.elem).css({
      'background-position': this.scenePos.x + 'px ' + this.scenePos.y + 'px'
    });
  }

  Game.prototype.checkObstacles = function() {
    // Nothing here yet.
  }

  Game.prototype.addCharacter = function(name, avatar) {
    /* Create main character */
    var newCharacter = new Character(name, avatar, 350, 300);
    newCharacter.create(this);
    this.characters.push(newCharacter);
  }

  /* Character Constructor and Methods */
  function Character(name, avatar, x, y) {
    this.elem = null;
    this.bounds = null;
    this.name = name;
    this.image = avatar;
    this.x = x;
    this.y = y;
    this.backX = 0;
    this.backY = 0;
    this.speed = 20;
    this.action = 'stand';
  }

  Character.prototype.create = function() {
    $('<div>').attr({
      'class': 'character',
      'name': this.name
    }).css({
      'position': 'absolute',
      'left': this.x,
      'top': this.y,
      'height': '120px',
      'width': '60px',
      'background-image': 'url(' + this.image + ')',
      'background-size': '400% 400%',
    }).appendTo($('.game-container'));
    var htmlElem = $('.character').last()[0];
    this.elem = htmlElem;
  }

  Character.prototype.updateCharacter = function() {
    var action = this.action;
    switch (action) {
      case 'stand':
        this.move.stop(this);
        break;
      case 'walk-left':
        this.move.left(this);
        break;
      case 'walk-right':
        this.move.right(this);
        break;
      case 'walk-up':
        this.move.up(this);
        break;
      case 'walk-down':
        this.move.down(this);
        break;
    }
    this.draw(action);
    this.bounds = this.elem.getBoundingClientRect();
  }

  Character.prototype.move = {
    stop: function(self) {
      // Do nothing for now
    },
    left: function(self) {
      self.x -= self.speed;
    },
    right: function(self) {
      self.x += self.speed;
    },
    up: function(self) {
      self.y -= self.speed;
    },
    down: function(self) {
      self.y += self.speed;
    }
  }

  Character.prototype.draw = function(action) {
    var $self = $(this.elem);
    $self.css({
      'left': this.x,
      'top': this.y
    });
    switch (action) {
      case 'walk-left':
        this.backX += 60;
        this.backY = 360;
        break;
      case 'walk-right':
        this.backX += 60;
        this.backY = 240;
        break;
      case 'walk-up':
        this.backX += 60;
        this.backY = 120;
        break;
      case 'walk-down':
        this.backX += 60;
        this.backY = 0;
        break;
    }
    $self.css({
      'background-position': this.backX + 'px ' + this.backY + 'px'
    });
  }

  var game;
  // setTimeout(function() {
    /* Create new game */
    game = new Game();
    game.init();
  // }, 100);


  return {
    game: game
  }

})();
